# Container

主要关注服务之间的协调及管理

### 服务注册与发现：

container 包负责将 IM 系统中的各个服务注册到服务发现系统（如 Consul）中，以便其他服务可以发现和访问它们。

### 客户端管理：

container 包管理客户端连接，允许不同的服务之间建立连接，以便进行消息传递和通信。

### 负载均衡：

通过选择器（如哈希选择器 HashSelector）实现负载均衡，确保消息和请求根据一定的规则分发给不同的服务，以实现负载均衡和故障转移。

### 服务监控：

container 包提供了监控功能，包括使用 Prometheus 进行性能监控以及提供健康检查接口，以确保系统的可用性。

### 启动和关闭：

container 包负责启动和关闭整个 IM 系统，包括启动服务、建立客户端连接、注册服务、监控信号等。

总体来看，该层负责协调和管理不同服务之间的重要角色，确保它们能够协同工作，实现消息传递、负载均衡和高可用性。

## clients.go

### ClientMap 接口：

定义了管理客户端集合的方法，包括添加、移除、获取客户端以及根据键值对过滤服务列表。

### ClientsImpl 结构体：

这是 ClientMap 接口的具体实现，使用了 sync.Map 来存储客户端连接。

### NewClients 函数：

用于创建一个新的 ClientsImpl 实例，接受一个参数 num，表示初始容量。

### Add 方法：

用于向客户端集合中添加一个客户端连接，需要提供客户端的唯一标识（ServiceID）。

### Remove 方法：

用于移除客户端集合中的客户端，根据客户端的唯一标识（ServiceID）来删除。

### Get 方法：

根据客户端的唯一标识（ServiceID）获取客户端连接，返回该客户端以及一个布尔值表示是否成功获取。

### Services 方法：

根据键值对过滤服务列表，可以传入一对键值对（例如：状态和状态值），返回符合条件的服务列表。

主要用于管理客户端连接，包括添加、移除和获取客户端，还可以根据一定条件筛选服务列表。这对于容器模块来说非常重要，因为容器需要维护与依赖服务的连接。

## container.go

### Container 结构体：

它用于管理容器的状态、服务、依赖服务、连接等信息。

### Init 函数：

用于初始化容器，接受一个服务和一组依赖服务的名称，以及一些其他配置。这个函数初始化容器状态并记录服务及其依赖。

### Start 函数：

用于启动容器。它包括以下步骤：

- 启动服务。

- 与依赖的服务建立连接。

- 注册服务。

- 等待系统关闭信号。

### Push 函数：

用于将消息推送到指定的服务器。

### Forward 函数：

用于将消息转发给客户端服务。

### SetDialer 函数：

设置 TCP 连接的拨号器。

### EnableMonitor 函数：

启动 Prometheus 监控的 HTTP 服务器。

### SetSelector 函数：

允许上层业务注册自定义的服务路由器。

### SetServiceNaming 函数：

设置服务的命名服务。

### connect2Service 函数：

建立与依赖服务的连接。它包括以下步骤：

- 监视新服务的注册。

- 查询已经存在的服务。

- 建立客户端连接。

### readLoop 函数：

处理从依赖服务接收的消息，将其推送到容器内的通道中。

## selector.go

### Selector 接口：

这是一个接口，定义了选择器的行为。选择器的作用是**将请求或流量分发给适当的容器或实例，以实现负载均衡、故障转移**等功能。除了 HashSelector，还可以有其他选择器，如最少连接数、随机、轮询、加权等，以满足不同的选择策略需求。

### HashCode 函数：

这个函数用于生成一个哈希码，将输入的 key 通过 CRC32 算法计算得到一个数字。这个哈希码可以用来选择服务。在此代码中，哈希码用于将消息根据 ChannelID 分发给适当的逻辑服务。通过取模运算，确保同一个用户的消息始终会分发到同一台逻辑服务上。

### HashSelector 结构体：

这是一个具体的选择器实现，实现了 Selector 接口。在 HashSelector 中，Lookup 方法根据 header 和服务列表 srvs 选择适当的服务。它使用 HashCode 函数生成哈希码，并将哈希码对服务数量取模，以确定选择哪个服务。