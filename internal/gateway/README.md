# Gateway

长连接接入层，管理用户连接以及传递消息

### docker-compose相关的prometheus.yml

进入到 ~/data/prometheus 目录。如果该目录不存在，需要先创建它

```bash
mkdir -p ~/data/prometheus
```

### 作用： 

Gateway 是用户和 IM 系统之间的接口，负责用户接入、验证和消息传递等任务。

### 用户接入管理： 

Gateway 管理用户连接，处理用户的登录、连接建立和断开等操作。

### 安全验证： 

它执行用户身份验证，确保只有合法用户可以访问 IM 系统。

### 负载均衡： 

Gateway 负责根据用户请求和负载情况，将请求分发给适当的逻辑服务，实现负载均衡。

### 消息处理： 

Gateway 可以处理用户之间的消息传递，包括消息的路由、转发和处理。它确保消息从发送者传递到接收者，并确保消息的可靠传递。

### 心跳检测： 

它定期检测客户端连接的状态，以确保连接的可用性，并处理连接出现问题的情况。

### 故障处理： 

Gateway 可以检测到逻辑服务的故障或不可用情况，并采取措施来处理，如重新分配请求或通知管理员。

### 数据统计和监控： 

它记录用户活动和系统性能数据，向监控系统报告，实时监控系统状态和性能。

## dialer.go

### TCPDialer 结构体：

实现了 x.Dialer 接口，用于建立与其他服务的连接。

### NewDialer 函数：

用于创建一个新的 TCPDialer 实例，其中 serviceID 用于指定服务的唯一标识。

### DialAndHandshake 方法：

用于建立连接并进行握手

- 建立 TCP 连接到指定的地址。

- 创建一个握手请求 (InnerHandshakeReq)，其中包含了当前服务的 ServiceID。

- 发送握手请求给对方服务。

- 返回建立的连接。

## handler.go

### Handler 结构体:

负责处理网关的连接、消息接收和断开连接等操作。

### Accept 方法:

用于处理客户端连接，它执行以下操作：

- 读取登录包，验证登录请求。

- 解析登录包中的 Token，用于身份验证。

- 生成全局唯一的 ChannelID，将其注入到登录包中。

- 转发登录请求给 Login 服务。

### Receive 方法:

用于处理消息的接收

- 接收消息包，包括心跳包。

- 如果收到心跳包 (Ping)，则回复心跳响应 (Pong)。

- 如果是普通消息包，将消息包的 ChannelID 设置为当前连接的 ID，然后将消息包转发给相应的逻辑服务。

### Disconnect 方法:

用于处理客户端断开连接

根据传入的连接 ID，发送登出请求给 Login 服务。

### getIP 函数:

用于从连接的远程地址中提取 IP 地址。

### generateChannelID 函数:

用于生成全局唯一的 ChannelID，结合服务的 ServiceID 和用户的帐号。

## selector.go

### RouteSelector 结构体

代表选择器，其包含了一个指向路由配置的指针。

### NewRouteSelector 函数

用于创建一个新的 RouteSelector 实例，它需要一个配置文件路径作为参数，从该配置文件中读取路由信息。如果读取配置文件出错，它会返回错误。

### Lookup 方法

是选择器的核心功能，用于根据请求的元信息来选择逻辑服务。

- 从请求的头部元信息中提取应用程序（app）和帐号（account）信息。

- 检查是否命中白名单（Whitelist）。如果未命中，则执行以下步骤：

- 根据路由策略（RouteBy）选择用于计算 zone 的键，通常是应用程序或帐号。

- 通过哈希计算来确定 zone。

- 从 zone 中筛选出当前可用的服务器列表（zoneSrvs）。

- 如果没有找到任何服务器，则选择一个随机的服务器。

- 否则，从 zoneSrvs 中选择一个逻辑服务，这一选择是根据帐号信息哈希到一个槽位上，再根据槽位选择一个服务。

### filterSrvs 函数

用于根据 zone 过滤出具有指定区域标签的服务器，返回一个 zoneSrvs 列表。

### selectSrvs 函数

用于选择一个逻辑服务，它会根据用户帐号信息计算哈希槽位，并选择一个槽位上的服务。这有助于实现负载均衡。

### hashcode 函数

用于计算给定字符串的哈希码，这里使用 CRC32 算法计算。它返回一个整数哈希值。